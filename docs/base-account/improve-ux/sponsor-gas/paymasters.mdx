---
title: "Спонсирование комиссий"
description: "Используйте Paymaster'ы для спонсирования транзакций ваших пользователей"
---

Одним из ключевых улучшений пользовательского опыта, которое предоставляет Base Account, является возможность для разработчиков приложений спонсировать транзакции своих пользователей.
Если ваше приложение поддерживает Base Account, вы можете начать спонсировать транзакции пользователей, используя [стандартизированную коммуникацию со службой Paymaster](https://erc7677.xyz) обеспечиваемую [новыми RPC-методами кошелька](https://eip5792.xyz).

Данное руководство специфично для использования Base Account. Более подробную информацию об использовании Paymaster'ов на Base вы можете найти 
на странице [Base Go Gasless page](/cookbook/go-gasless).

## Руководство по реализации

<Steps>
  <Step title="Настройте вашу службу Paymaster">
  В качестве предварительного условия вам необходимо получить URL службы Paymaster от провайдера этой услуги.

  Мы будем использовать [Coinbase Developer Platform](https://www.coinbase.com/developer-platform) в качестве провайдера услуг Paymaster,
  который в настоящее время предлагает до $15 тыс. в виде грантов на газ в рамках [Base Gasless Campaign](/base-account/more/base-gasless-campaign).

  <Warning>
  **Провайдеры Paymaster, совместимые с ERC-7677**

  Если вы решите использовать другого провайдера услуг Paymaster, убедитесь, что он [совместим с ERC-7677](https://www.erc7677.xyz/ecosystem/paymasters).

  </Warning>

  После регистрации в [Coinbase Developer Platform](https://www.coinbase.com/developer-platform), вы получите URL вашей службы Paymaster, перейдя в раздел **Onchain Tools > Paymaster**, как показано ниже:

  <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
<Frame>
    <img
      alt="Paymaster CDP"
      src="/images/smart-wallet/PaymasterCDP.png"
      width="1000"
      loading="lazy"
    />
</Frame>
    <em>Как получить URL вашей службы Paymaster</em>
  </div>

  <Warning>
  **Стоит ли создавать прокси для вашей службы Paymaster?**

  Мы рекомендуем использовать прокси для защиты URL службы Paymaster, чтобы предотвратить его раскрытие/утечку на клиентской стороне (frontend).

  Для локальной разработки вы можете использовать один и тот же URL для службы Paymaster и прокси.

  </Warning>

  Получив URL службы Paymaster, вы можете перейти к настройке разрешительного списка (allowlist) контрактов.
  Это список контрактов и вызовов функций, которые вы хотите, чтобы Paymaster спонсировал.

  <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
<Frame>
    <img
      alt="Paymaster CDP Allowlist"
      src="/images/smart-wallet/PaymasterAllowlist.png"
      width="1000"
      loading="lazy"
    />
</Frame>
    <em>Как настроить разрешительный список контрактов Paymaster</em>
  </div>

  Поздравляем! Вы настроили службу Paymaster и разрешительный список контрактов.
  Пришло время настроить SDK для Base Account.

  <Check>
  **Вы также можете создать собственные расширенные политики!**

  При необходимости более тонкого контроля над применением политик вы можете создать функцию `willSponsor` для дополнительной валидации.

  Скорее всего, функция `willSponsor` не понадобится, если вы используете [Coinbase Developer Platform](https://www.coinbase.com/developer-platform)так как он имеет встроенные функции применения политик,
  но знайте, что эта возможность всё равно доступна, если она вам нужна.

  </Check>
  
  </Step>
  <Step title="Настройка SDK Base Account">
  Установите и инициализируйте SDK Base Account для взаимодействия со смарт-аккаунтом:

  ### Установка

  <CodeGroup>
  ```bash npm
  npm install @base-org/account
  ```

  ```bash pnpm
  pnpm add @base-org/account
  ```

  ```bash yarn
  yarn add @base-org/account
  ```

  ```bash bun
  bun add @base-org/account
  ```
  </CodeGroup>

  ### Инициализация SDK

  ```tsx
  import { createBaseAccountSDK, base } from '@base-org/account';

  const sdk = createBaseAccountSDK({
    appName: 'Paymaster Demo',
    appLogoUrl: 'https://base.org/logo.png',
    appChainIds: [base.constants.CHAIN_IDS.baseSepolia], // или base.constants.CHAIN_IDS.base для мейннета
  });

  const provider = sdk.getProvider();
  ```

  </Step>
  <Step title="Отправка транзакций с поддержкой Paymaster">
  После настройки службы Paymaster вы можете использовать метод `wallet_sendCalls` с возможностями paymaster для спонсирования транзакций.

  <Note>
  **Передавайте URL прокси**

  Если вы настроили прокси в бэкенде вашего приложения, как рекомендуется в шаге (1) выше, вам нужно передать созданный вами URL прокси.

  </Note>

  ### Базовая спонсируемая транзакция

  Вот как отправить спонсируемую транзакцию с помощью RPC-метода `wallet_sendCalls`:

  ```tsx
  import { createBaseAccountSDK, getCryptoKeyAccount, base } from '@base-org/account';
  import { numberToHex, encodeFunctionData, parseEther } from 'viem';

  // Пример ABI контракта NFT
  const nftABI = [
    {
      name: 'safeMint',
      type: 'function',
      stateMutability: 'nonpayable',
      inputs: [{ name: 'to', type: 'address' }],
      outputs: []
    }
  ] as const;

  async function sendSponsoredTransaction() {
    const sdk = createBaseAccountSDK({
      appName: 'Paymaster Demo',
      appLogoUrl: 'https://base.org/logo.png',
      appChainIds: [base.constants.CHAIN_IDS.baseSepolia],
    });

    const provider = sdk.getProvider();
    
    try {
      // Получаем аккаунт пользователя
      const cryptoAccount = await getCryptoKeyAccount();
      const fromAddress = cryptoAccount?.account?.address;
      
      if (!fromAddress) {
        throw new Error('No account found');
      }

      // URL вашей службы Paymaster (используйте URL вашего прокси)
      const paymasterServiceUrl = process.env.NEXT_PUBLIC_PAYMASTER_PROXY_SERVER_URL;
      
      // Подготавливаем вызов транзакции
      const nftAddress = '0x119Ea671030FBf79AB93b436D2E20af6ea469a19';
      const calls = [
        {
          to: nftAddress,
          value: '0x0',
          data: encodeFunctionData({
            abi: nftABI,
            functionName: 'safeMint',
            args: [fromAddress]
          })
        }
      ];

      // Отправляем транзакцию с возможностями paymaster
      const result = await provider.request({
        method: 'wallet_sendCalls',
        params: [{
          version: '1.0',
          chainId: numberToHex(base.constants.CHAIN_IDS.baseSepolia),
          from: fromAddress,
          calls: calls,
          capabilities: {
            paymasterService: {
              url: paymasterServiceUrl
            }
          }
        }]
      });

      console.log('Sponsored transaction sent:', result);
      return result;
    } catch (error) {
      console.error('Sponsored transaction failed:', error);
      throw error;
    }
  }
  ```

  ### Несколько спонсируемых транзакций

  Вы также можете объединить несколько транзакций в пакет (batch), и все они будут спонсированы:

  ```tsx
  async function sendMultipleSponsoredTransactions() {
    const sdk = createBaseAccountSDK({
      appName: 'Paymaster Demo',
      appLogoUrl: 'https://base.org/logo.png',
      appChainIds: [base.constants.CHAIN_IDS.baseSepolia],
    });

    const provider = sdk.getProvider();
    const cryptoAccount = await getCryptoKeyAccount();
    const fromAddress = cryptoAccount?.account?.address;

    const paymasterServiceUrl = process.env.NEXT_PUBLIC_PAYMASTER_PROXY_SERVER_URL;

    // Несколько вызовов в одной спонсируемой транзакции
    const calls = [
      {
        to: '0xd8da6bf26964af9d7eed9e03e53415d37aa96045',
        value: numberToHex(parseEther('0.001')),
        data: '0x' // Простой перевод ETH
      },
      {
        to: '0x742d35Cc6634C0532925a3b844Bc9e7595f6E456',
        value: numberToHex(parseEther('0.001')),
        data: '0x' // Еще один перевод ETH
      }
    ];

    const result = await provider.request({
      method: 'wallet_sendCalls',
      params: [{
        version: '1.0',
        chainId: numberToHex(base.constants.CHAIN_IDS.baseSepolia),
        from: fromAddress,
        calls: calls,
        capabilities: {
          paymasterService: {
            url: paymasterServiceUrl
          }
        }
      }]
    });

    return result;
  }
  ```

  ### Проверка поддержки Paymaster

  Перед отправкой спонсируемых транзакций вы можете проверить, поддерживает ли кошелек услуги paymaster:

  ```tsx
  async function checkPaymasterSupport() {
    const sdk = createBaseAccountSDK({
      appName: 'Paymaster Demo',
      appLogoUrl: 'https://base.org/logo.png',
      appChainIds: [base.constants.CHAIN_IDS.baseSepolia],
    });

    const provider = sdk.getProvider();
    const cryptoAccount = await getCryptoKeyAccount();
    const address = cryptoAccount?.account?.address;

    try {
      const capabilities = await provider.request({
        method: 'wallet_getCapabilities',
        params: [address]
      });

      const baseCapabilities = capabilities[base.constants.CHAIN_IDS.baseSepolia];
      
      if (baseCapabilities?.paymasterService?.supported) {
        console.log('Paymaster service is supported');
        return true;
      } else {
        console.log('Paymaster service is not supported');
        return false;
      }
    } catch (error) {
      console.error('Failed to check paymaster capabilities:', error);
      return false;
    }
  }
  ```

  Вот и всё! Base Account позаботится обо всём остальном. Если ваша служба Paymaster может спонсировать транзакцию,
  в интерфейсе Base Account укажет вашему пользователю, что транзакция спонсируется.

  </Step>
</Steps>
