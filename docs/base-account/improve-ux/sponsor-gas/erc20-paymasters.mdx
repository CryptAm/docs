---
title: "Оплата комиссий токенами ERC20"
description: "Base Account позволяет пользователям оплачивать комиссии (gas) токенами стандарта ERC20"
---


Base Account позволяет пользователям оплачивать комиссии (gas) токенами стандарта ERC20!
Токены могут быть приняты в качестве оплаты через переданные в приложении paymaster'ы, в дополнение к набору универсально поддерживаемых токенов, таких как USDC (этот набор будет расширен в ближайшее время).

Это руководство описывает, как настроить собственный paymaster для вашего приложения, который будет принимать ваш токен в качестве оплаты.

### Выберите провайдера услуги paymaster

В качестве предварительного условия вам необходимо получить URL службы paymaster от провайдера. Paymaster'ы для токенов ERC20 имеют дополнительные требования, которые будут описаны ниже.

Мы рекомендуем paymaster от [Coinbase Developer Platform](https://www.coinbase.com/developer-platform), поскольку он полностью готов к работе с оплатой комиссий токенами ERC20 в Base Account "из коробки". CDP также предлагает до $15 тыс. в виде грантов на газ в рамках [Base Gasless Campaign](/base-account/more/base-gasless-campaign).

Если вы используете другого провайдера paymaster, он должен соответствовать спецификации, изложенной в разделе [ERC20 Compatible Paymasters](#erc20-compatible-paymasters) чтобы корректно работать с Base Account.

### Настройка приложения для пользовательского токена

После того как у вас есть paymaster, совместимый с оплатой комиссий токенами ERC20 в Base Account, ваша задача - только включить разрешения (approvals) для вашего токена в адрес paymaster. Рекомендуется периодически пополнять разрешение, когда его остаток достигает определенного порога.

```js

const tokenDecimals = 6
const minTokenThreshold = 1 * 10 ** tokenDecimals // $1
const tokenApprovalTopUp = 20 * 10 ** tokenDecimals // $20
const tokenAddress = "0x833589fcd6edb6e08f4c7c32d4f71b54bda02913"
const nftContractAddress = "0x66519FCAee1Ed65bc9e0aCc25cCD900668D3eD49"
const paymasterAddress = "0x2FAEB0760D4230Ef2aC21496Bb4F0b47D634FD4c"

const mintTo = {
  abi: abi,
  functionName: "mintTo",
  to: nftContractAddress,
  args: [account.address, 1],
};

calls = [mintTo]

// Проверяем allowance (разрешенную сумму)
const allowance = await client.readContract({
  abi: parseAbi(["function allowance(address owner, address spender) returns (uint256)"]),
  address: tokenAddress,
  functionName: "allowance",
  args: [account.address, paymasterAddress],
})

if (allowance < minTokenThreshold) {
   // Добавляем вызов approve на $20 в список calls, чтобы paymaster мог переместить токены для принятия оплаты
   calls.push({
        abi: ["function approve(address,uint)"],
        functionName: "approve",
        to: nftContractAddress,
        args: [paymasterAddress, tokenApprovalTopUp],
    })
}
```

Это всё! Base Account позаботится об остальном, при условии что paymaster совместим, как описано ниже.

### Совместимые с ERC20 Paymaster

Coinbase Developer Platform совместим "из коробки", и мы работаем с другими командами, чтобы вскоре добавить поддержку и у них!

Paymaster должен обрабатывать JSON-RPC запросы `pm_getPaymasterStubData` и `pm_getPaymasterData`, указанные в ERC-7677, в дополнение к `pm_getAcceptedPaymentTokens`. Мы разберем каждый запрос и ответ ниже.

#### pm_getPaymasterStubData and pm_getPaymasterData

1. Paymaster должен использовать указанный токен ERC20 для оплаты, если он указан в поле контекста `erc20` согласно спецификации 7677.
2. При отказе / неудаче paymaster должен возвращать поле `data` в JSONRPC-ответе, которое может быть использовано для выдачи разрешения (approve) paymaster'у. Оно должно включать:

- Массив `acceptedTokens`, который представляет собой структуру, содержащую адрес токена.
- Поле `paymasterAddress` - адрес paymaster'а, который будет выполнять перевод токенов.

3. При успехе paymaster должен возвращать поле `tokenPayment` в результате. Оно включает:

- `tokenAddress` - адрес токена, использованного для оплаты.
- `maxFee` - максимальная комиссия для отображения в интерфейсе.
- `decimals` - количество знаков после запятой (децималы) для использования в интерфейсе.
- `name` - название токена.

Base Account выполнит симуляцию транзакции, чтобы убедиться в успехе и точности информации.

##### Запрос

Это пример стандартного запроса Entrypoint V0.6 с дополнительным контекстом для указания токена, который следует использовать.

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "pm_getPaymasterData",
  "params": [
    {
      "sender": "0xe62B4aD6A7c079F47D77a9b939D5DC67A0dcdC2B",
      "nonce": "0x4e",
      "initCode": "0x",
      "callData": "0xb61d27f60000000000000000000000007746371e8df1d7099a84c20ed72e3335fb016b23000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000",
      "callGasLimit": "0x113e10",
      "verificationGasLimit": "0x113e10",
      "preVerificationGas": "0x113e10",
      "maxFeePerGas": "0x113e10",
      "maxPriorityFeePerGas": "0x113e10",
      "paymasterAndData": "0x",
      "signature": "0x5ee079a5dec73fe39c1ce323955fb1158fc1b9a6b2ddbec104cd5cfec740fa5531584f098b0ca95331b6e316bd76091e3ab75a7bc17c12488664d27caf19197e1c"
    },
    "0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789",
    "0x2105",
    {
      "erc20": "0x833589fcd6edb6e08f4c7c32d4f71b54bda02913"
    }
  ]
}
```

##### Ответ

Успешный ответ:

```json
{
  "id": 1,
  "jsonrpc": "2.0",
  "result": {
    "paymasterAndData": "0x2faeb0760d4230ef2ac21496bb4f0b47d634fd4c0000670fdc98000000000000494b3b6e1d074fbca920212019837860000100833589fcd6edb6e08f4c7c32d4f71b54bda029137746371e8df1d7099a84c20ed72e3335fb016b23000000000000000000000000000000000000000000000000000000009b75458400000000697841102cd520d4e0171a58dadc3e6086111a49a90826cb0ad25579f25f1652081f68c17d8652387a33bf8880dc44ecf95be4213e786566d755baa6299f477b0bb21c",
    "tokenPayment": {
      "name": "USDC",
      "address": "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
      "maxFee": "0xa7c8",
      "decimals": 6
    }
  }
}
```

Ответ при отказе:

```json
{
  "id": 1,
  "jsonrpc": "2.0",
  "error": {
    "code": -32002,
    "message": "request denied - no sponsorship and address can not pay with accepted token",
    "data": {
      "acceptedTokens": [
        {
          "name": "USDC",
          "address": "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"
        }
      ]
    }
  }
}
```

#### pm_getAcceptedPaymentTokens

`pm_getAcceptedPaymentTokens` возвращает массив токенов, которые paymaster примет в качестве оплаты.
Запрос содержит адрес Entrypoint и идентификатор цепи (Chain ID) с опциональным контекстом.

##### Запрос

```json
{
  "jsonrpc": "2.0", "id": 1,
  "method": "pm_getAcceptedPaymentTokens",
  "params": [ "0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789", "0x2105", {}]
}
```

##### Ответ

```json
{
  "id": 1,
  "jsonrpc": "2.0",
  "result": {
    "acceptedTokens": [
      {
        "name": "USDC",
        "address": "0x833589fcd6edb6e08f4c7c32d4f71b54bda02913"
      }
    ]
  }
}
```
