---
title: "Использование разрешений на расходование"
description: "Узнайте, как использовать Spend Permissions для предоставления доверенной стороне права расходовать активы пользователя"
---

## Обзор

Разрешения на расходование (Spend Permissions) позволяют назначить доверенную сторону (`spender`), которая может перемещать активы из Base Account пользователя от его имени.

После того как пользователь подписывает разрешение, `spender` может инициировать переводы в пределах установленных вами лимитов - без дополнительных запросов, всплывающих окон или подписей от пользователя. Это обеспечивает бесперебойную работу для таких сценариев, как продление подписок, алгоритмическая торговля и автоматические выплаты.

Подробнее о контракте менеджера Spend Permissions и поддерживаемых цепях читайте на [GitHub](https://github.com/coinbase/spend-permissions).

<Callout type="info">
  Поддержка Spend Permissions для мини-приложений Base App появится в ближайшем будущем и будет добавлена в одном из следующих обновлений.
</Callout>

<Note>
Если вы используете Суб-аккаунты (Sub Accounts), узнайте, как Base Account может автоматически пополнять их и, при желании, пропускать запросы на подтверждение, используя [Auto Spend Permissions](/base-account/improve-ux/sub-accounts#auto-spend-permissions).
</Note>

## Использование

### Запрос разрешения на расходование

Вы создаете полезную нагрузку (payload) EIP-712, описывающую разрешение, и просите пользователя подписать её. Сохраните полученную подпись вместе с данными разрешения, чтобы позднее зарегистрировать его в блокчейне. Помощник SDK ниже позаботится о формировании и подписании за вас.

| Название поля  | Тип       | Описание                                                                                             |
| -------------- | --------- | ---------------------------------------------------------------------------------------------------- |
| `account`      | `address` | Смарт-аккаунт, для которого действительно данное разрешение на расходование                          |
| `spender`      | `address` | Субъект, который может расходовать токены `account`                                                  |
| `token`        | `address` | Адрес токена (нативный токен ERC-7528 или контракт ERC-20)                                           |
| `allowance`    | `uint160` | Максимальное допустимое значение для расходования в течение каждого `period`                         |
| `period`       | `uint48`  | Продолжительность времени для сброса использованного `allowance` на регулярной основе (в секундах)   |
| `start`        | `uint48`  | Метка времени, начиная с которой разрешение действительно (включительно, Unix секунды)               |
| `end`          | `uint48`  | Метка времени, до которой разрешение действительно (исключительно, Unix секунды)                     |
| `salt`         | `uint256` | Произвольные данные для различения уникальных разрешений с идентичными остальными полями             |
| `extraData`    | `bytes`   | Произвольные данные, прикрепляемые к разрешению, которые могут быть использованы стороной `spender`  |

```tsx
import { requestSpendPermission } from "@base-org/account/spend-permission";
import { createBaseAccountSDK } from "@base-org/account";
import { base } from "viem/chains";

const sdk = createBaseAccountSDK({
  appName: 'Base Account SDK Demo',
  appLogoUrl: 'https://base.org/logo.png',
  appChainIds: [base.id],
});

const permission = await requestSpendPermission({
  account: "0x...",
  spender: "0x...",
  token: "0x...",
  chainId: 8453, // или любой другая поддерживаемая цепь
  allowance: 1_000_000n,
  periodInDays: 30,
  provider: sdk.getProvider(),
});

console.log("Spend Permission:", permission);
```

### Использование разрешения на расходование

Использование разрешения состоит из 2 шагов:

1. **Подготовка вызовов** — Вызовите `prepareSpendCallData` с разрешением и запрашиваемой `amount`.
2. **Отправка вызовов** — Отправьте вызовы, используя смарт-аккаунт spender вашего приложения.

`prepareSpendCallData` возвращает массив вызовов, необходимых для расходования токенов:

- `approveWithSignature` — Когда разрешение еще не зарегистрировано в блокчейне, этот вызов будет добавлен перед вызовом `spend`.
- `spend` — Вызов для расходования токенов из Base Account пользователя.

```tsx
import { prepareSpendCallData } from "@base-org/account/spend-permission";

// возвращает [approveWithSignatureCall, spendCall]
const spendCalls = await prepareSpendCallData({
  permission,
  amount, // опционально; опустите, чтобы потратить оставшийся лимит
});

// Если смарт-аккаунт spender вашего приложения поддерживает wallet_sendCalls, отправьте их пакетно, используя wallet_sendCalls
// это пример того, как это сделать через интерфейс provider
await provider.request({
  method: "wallet_sendCalls",
  params: [
    {
      version: "2.0",
      atomicRequired: true,
      from: spender,
      calls: spendCalls,
    },
  ],
});

// Если смарт-аккаунт spender вашего приложения не поддерживает wallet_sendCalls, отправьте их по порядку, используя eth_sendTransaction
// это пример того, как это сделать через интерфейс provider
await Promise.all(
  spendCalls.map((call) =>
    provider.request({
      method: "eth_sendTransaction",
      params: [
        {
          ...call,
          from: spender,
        },
      ],
    })
  )
);
```

<Note>
**О массиве `spendCalls`**

Этот массив содержит 2 вызова при первой регистрации разрешения в блокчейне.
Когда разрешение уже зарегистрировано, массив содержит только 1 вызов (вызов `spend`).

Для большинства случаев использования вам не нужно об этом беспокоиться.
</Note>

### Отзыв разрешения на расходование

Вы можете отозвать разрешение двумя способами:

- Запросить подтверждение пользователя через его Base Account с помощью `requestRevoke`.
- Отозвать автоматически со смарт-аккаунта spender вашего приложения, отправив вызов, возвращенный функцией `prepareRevokeCallData`.

```tsx
import {
  requestRevoke,
  prepareRevokeCallData,
} from "@base-org/account/spend-permission";

// Вариант А: Отзыв, инициированный пользователем (всплывающее окно кошелька)
try {
  const hash = await requestRevoke(permission);
  console.log("Revoke succeeded", hash);
} catch {
  console.warn("Revoke was rejected or failed");
}

// Вариант Б: Автоматический отзыв со смарт-аккаунта spender вашего приложения
const revokeCall = await prepareRevokeCallData(permission);

// Отправьте вызов отзыва, используя смарт-аккаунт spender вашего приложения
// это пример того, как это сделать через интерфейс provider
await provider.request({
  method: "wallet_sendCalls",
  params: [
    {
      version: "2.0",
      atomicRequired: true,
      from: spender,
      calls: [revokeCall],
    },
  ],
});

// Если смарт-аккаунт spender вашего приложения не поддерживает wallet_sendCalls, отправьте вызов отзыва, используя eth_sendTransaction
// это пример того, как это сделать через интерфейс provider
await provider.request({
  method: "eth_sendTransaction",
  params: [
    {
      ...revokeCall,
      from: spender,
    },
  ],
});
```

## Справочник API

- [requestSpendPermission](/base-account/reference/spend-permission-utilities/requestSpendPermission)
- [prepareSpendCallData](/base-account/reference/spend-permission-utilities/prepareSpendCallData)
- [requestRevoke](/base-account/reference/spend-permission-utilities/requestRevoke)
- [prepareRevokeCallData](/base-account/reference/spend-permission-utilities/prepareRevokeCallData)
- [fetchPermissions](/base-account/reference/spend-permission-utilities/fetchPermissions)
- [fetchPermission](/base-account/reference/spend-permission-utilities/fetchPermission)
- [getPermissionStatus](/base-account/reference/spend-permission-utilities/getPermissionStatus)

## Пример полной интеграции

```typescript
import {
  fetchPermissions,
  fetchPermission,
  getPermissionStatus,
  prepareSpendCallData,
  requestSpendPermission,
  requestRevoke,
  prepareRevokeCallData,
} from "@base-org/account/spend-permission";

import { createBaseAccountSDK } from "@base-org/account";
import { base } from "viem/chains";

const sdk = createBaseAccountSDK({
  appName: 'Base Account SDK Demo',
  appLogoUrl: 'https://base.org/logo.png',
  appChainIds: [base.id],
});

const spender = "0xAppSpenderAddress";

// 1) Получить конкретное разрешение по его хэшу
// Используйте fetchPermission, когда уже знаете хэш разрешения
// (например, сохраненный из предыдущей сессии или переданный как параметр)
const permission = await fetchPermission({
  permissionHash: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef",
  provider: sdk.getProvider(),
});

// Альтернатива: Получить все разрешения для spender
// Используйте fetchPermissions, когда нужно увидеть все доступные разрешения
// и выбрать, какое из них использовать
// const permissions = await fetchPermissions({
//   account: "0xUserBaseAccountAddress",
//   chainId: 84532,
//   spender,
//   provider: sdk.getProvider(),
// });
// const permission = permissions.at(0);

// ========================================
// Когда разрешение УЖЕ существует
// ========================================

// 2. Проверить статус разрешения
try {
  const { isActive, remainingSpend } = await getPermissionStatus(permission);
  const amount = 1000n;

  if (!isActive || remainingSpend < amount) {
    throw new Error("No spend permission available");
  }
} catch {
  throw new Error("No spend permission available");
}

// 3. Подготовить вызовы
const [approveCall, spendCall] = await prepareSpendCallData({
  permission,
  amount,
});

// 4. Выполнить вызовы, используя смарт-аккаунт spender вашего приложения
// это пример использования wallet_sendCalls, в продакшене можно использовать eth_sendTransaction.
await provider.request({
  method: "wallet_sendCalls",
  params: [
    {
      version: "2.0",
      atomicRequired: true,
      from: spender,
      calls: [approveCall, spendCall],
    },
  ],
});

// ========================================
// Когда разрешение НЕ существует
// ========================================

// 2. Запросить разрешение на расходование для использования
const newPermission = await requestSpendPermission({
  account: "0xUserBaseAccountAddress",
  spender,
  token: "0xTokenContractAddress",
  chainId: 84532,
  allowance: 1_000_000n,
  periodInDays: 30,
  provider: sdk.getProvider(),
});

// 3. Подготовить вызовы
const spendCalls = await prepareSpendCallData({
  permission: newPermission,
  amount: 1_000n,
});

// 4. Выполнить вызовы, используя смарт-аккаунт spender вашего приложения
// это пример использования eth_sendTransaction. Если смарт-аккаунт вашего приложения поддерживает wallet_sendCalls, используйте wallet_sendCalls для пакетной отправки.
await Promise.all(
  spendCalls.map((call) =>
    provider.request({
      method: "eth_sendTransaction",
      params: [
        {
          ...call,
          from: spender,
        },
      ],
    })
  )
);

// ========================================
// Запросить у пользователя отзыв разрешения
// ========================================

try {
  const hash = await requestRevoke(permission);
  console.log("Revoke succeeded", hash);
} catch {
  throw new Error("Revoke failed");
}

// ========================================
// Отозвать разрешение в фоновом режиме
// ========================================

const revokeCall = await prepareRevokeCallData(permission);

await provider.request({
  method: "wallet_sendCalls",
  params: [
    {
      version: "2.0",
      atomicRequired: true,
      from: spender,
      calls: [revokeCall],
    },
  ],
});
```

## Пример использования

Предположим, вы создаете AI-агента, который может автономно покупать [Zora Creator Coins](https://docs.zora.co/coins), используя безопасные [Spend Permissions](/base-account/improve-ux/spend-permissions) на Base.

Этот пример демонстрирует, как объединить [Spend Permissions](/base-account/improve-ux/spend-permissions) Base Account с [Server Wallets](https://docs.cdp.coinbase.com/server-wallets/v2/introduction/quickstart) and [Trade API](https://docs.cdp.coinbase.com/trade-api/quickstart) от Coinbase Developer Platform (CDP) для бесперебойных, не требующих комиссий транзакций AI-агента.

<Frame>

  <img
    src="/images/base-account/spend-permissions-agent.png"
    alt="Spend Permissions Agent Interface"
  />
</Frame>

<CardGroup cols={2}>
  <Card
    title="Живая демонстрация"
    icon="rocket"
    href="https://base-agent-spend-permissions.vercel.app"
  >
    Протестируйте живое приложение и посмотрите, как работают разрешения на расходование
  </Card>
  <Card
    title="Исходный код"
    icon="github"
    href="https://github.com/base/demos/tree/master/base-account/agent-spend-permissions"
  >
    Изучите полную реализацию на GitHub
  </Card>
</CardGroup>

**Узнать больше:** [AI Agent with Spend Permissions](/cookbook/spend-permissions-ai-agent)
