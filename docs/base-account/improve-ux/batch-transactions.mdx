---
title: "Пакетные транзакции"
---

С помощью Base Account вы можете отправлять несколько ончейн-вызовов в одной транзакции. Это улучшает пользовательский опыт (UX) многошаговых операций, сводя их к одному клику. Типичный пример, где можно использовать пакетные транзакции - это вызов `approve` для токена ERC-20, за которым следует обмен (swap).

Вы можете отправлять пакетные транзакции, используя RPC-метод `wallet_sendCalls`, определенный в [EIP-5792](https://eips.ethereum.org/EIPS/eip-5792).

## Установка

Установите SDK Base Account:

<CodeGroup>
```bash npm
npm install @base-org/account
```

```bash pnpm
pnpm add @base-org/account
```

```bash yarn
yarn add @base-org/account
```

```bash bun
bun add @base-org/account
```
</CodeGroup>

## Настройка

### Инициализация SDK

Импортируйте и создайте экземпляр SDK Base Account:

```tsx
import { createBaseAccountSDK, base } from '@base-org/account';

const sdk = createBaseAccountSDK({
  appName: 'Base Account SDK Demo',
  appLogoUrl: 'https://base.org/logo.png',
  appChainIds: [base.constants.CHAIN_IDS.base],
});

const provider = sdk.getProvider();
```

## Базовая пакетная транзакция

### Простые множественные переводы

Отправьте несколько переводов ETH в одной транзакции:

```tsx
import { createBaseAccountSDK, getCryptoKeyAccount, base } from '@base-org/account';
import { numberToHex, parseEther } from 'viem';

const sdk = createBaseAccountSDK({
  appName: 'Batch Transaction Demo',
  appLogoUrl: 'https://base.org/logo.png',
  appChainIds: [base.constants.CHAIN_IDS.base],
});

const provider = sdk.getProvider();

async function sendBatchTransfers() {
  try {
    // Получаем криптоаккаунт
    const cryptoAccount = await getCryptoKeyAccount();
    const fromAddress = cryptoAccount?.account?.address;

    // Подготавливаем пакет вызовов
    const calls = [
      {
        to: '0xd8da6bf26964af9d7eed9e03e53415d37aa96045',
        value: numberToHex(parseEther('0.001')), // 0.001 ETH
        data: '0x', // Пустые данные для простого перевода
      },
      {
        to: '0x742d35Cc6634C0532925a3b844Bc9e7595f6E456',
        value: numberToHex(parseEther('0.001')), // 0.001 ETH  
        data: '0x', // Пустые данные для простого перевода
      }
    ];

    // Отправляем пакетную транзакцию
    const result = await provider.request({
      method: 'wallet_sendCalls',
      params: [{
        version: '2.0.0',
        from: fromAddress,
        chainId: numberToHex(base.constants.CHAIN_IDS.base),
        atomicRequired: true, // Все вызовы должны завершиться успешно, иначе все будут отменены
        calls: calls
      }]
    });

    console.log('Batch transaction sent:', result);
    return result;
  } catch (error) {
    console.error('Batch transaction failed:', error);
    throw error;
  }
}
```

## Взаимодействие с контрактами

### Approve и перевод токена ERC-20

Часто встречающийся паттерн - утвердить (approve), а затем перевести токены ERC-20:

```tsx
import { createBaseAccountSDK, getCryptoKeyAccount, base } from '@base-org/account';
import { numberToHex, parseUnits, encodeFunctionData } from 'viem';

// ABI ERC-20 для функций approve и transfer
const erc20Abi = [
  {
    name: 'approve',
    type: 'function',
    stateMutability: 'nonpayable',
    inputs: [
      { name: 'spender', type: 'address' },
      { name: 'amount', type: 'uint256' }
    ],
    outputs: [{ name: '', type: 'bool' }]
  },
  {
    name: 'transfer',
    type: 'function', 
    stateMutability: 'nonpayable',
    inputs: [
      { name: 'to', type: 'address' },
      { name: 'amount', type: 'uint256' }
    ],
    outputs: [{ name: '', type: 'bool' }]
  }
] as const;

async function approveAndTransfer() {
  const sdk = createBaseAccountSDK({
    appName: 'ERC-20 Batch Demo',
    appLogoUrl: 'https://base.org/logo.png',
    appChainIds: [base.constants.CHAIN_IDS.base],
  });

  const provider = sdk.getProvider();
  const cryptoAccount = await getCryptoKeyAccount();
  const fromAddress = cryptoAccount?.account?.address;

  const tokenAddress = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913'; // USDC на Base
  const spenderAddress = '0x3fc91a3afd70395cd496c647d5a6cc9d4b2b7fad'; // Пример получателя разрешения
  const recipientAddress = '0xd8da6bf26964af9d7eed9e03e53415d37aa96045';
  const amount = parseUnits('10', 6); // 10 USDC (6 decimals)

  const calls = [
    {
      to: tokenAddress,
      value: '0x0',
      data: encodeFunctionData({
        abi: erc20Abi,
        functionName: 'approve',
        args: [spenderAddress, amount]
      })
    },
    {
      to: tokenAddress,
      value: '0x0', 
      data: encodeFunctionData({
        abi: erc20Abi,
        functionName: 'transfer',
        args: [recipientAddress, amount]
      })
    }
  ];

  const result = await provider.request({
    method: 'wallet_sendCalls',
    params: [{
      version: '2.0.0',
      from: fromAddress,
      chainId: numberToHex(base.constants.CHAIN_IDS.base),
      atomicRequired: true,
      calls: calls
    }]
  });

  return result;
}
```

## Расширенные возможности

### Проверка возможностей кошелька

Перед отправкой пакетных транзакций вы можете проверить, поддерживает ли кошелек атомарное объединение (atomic batching):

```tsx
async function checkCapabilities() {
  const provider = sdk.getProvider();
  
  try {
    const cryptoAccount = await getCryptoKeyAccount();
    const address = cryptoAccount?.account?.address;
    
    const capabilities = await provider.request({
      method: 'wallet_getCapabilities',
      params: [address]
    });
    
    const baseCapabilities = capabilities[base.constants.CHAIN_IDS.base];
    
    if (baseCapabilities?.atomicBatch?.supported) {
      console.log('Atomic batching is supported');
      return true;
    } else {
      console.log('Atomic batching is not supported');
      return false;
    }
  } catch (error) {
    console.error('Failed to check capabilities:', error);
    return false;
  }
}
```

### Неатомарное объединение

Иногда требуется, чтобы вызовы выполнялись последовательно, даже если некоторые из них завершатся неудачей:

```tsx
const result = await provider.request({
  method: 'wallet_sendCalls',
  params: [{
    version: '2.0.0',
    from: fromAddress,
    chainId: numberToHex(base.constants.CHAIN_IDS.base),
    atomicRequired: false, // Разрешить частичное выполнение
    calls: calls
  }]
});
```

## Обработка ошибок

Обработка типичных ошибок пакетных транзакций:

```tsx
async function sendBatchWithErrorHandling(calls: any[]) {
  try {
    const cryptoAccount = await getCryptoKeyAccount();
    const fromAddress = cryptoAccount?.account?.address;
    
    const result = await provider.request({
      method: 'wallet_sendCalls',
      params: [{
        version: '2.0.0',
        from: fromAddress,
        chainId: numberToHex(base.constants.CHAIN_IDS.base),
        atomicRequired: true,
        calls: calls
      }]
    });
    
    return { success: true, data: result };
  } catch (error: any) {
    console.error('Batch transaction error:', error);
    
    if (error.code === 4001) {
      return { success: false, error: 'User rejected the transaction' };
    } else if (error.code === 5740) {
      return { success: false, error: 'Batch too large for wallet to process' };
    } else if (error.code === -32602) {
      return { success: false, error: 'Invalid request format' };
    } else {
      return { success: false, error: error.message || 'Unknown error' };
    }
  }
}
```
